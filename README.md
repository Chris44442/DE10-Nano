# DE10-Nano Cyclone V SoC design for rapid prototyping

FPGA designs are notorious for being slow to deploy. Utilizing the power of embedded Linux, SD card flash memory, the HPS to FPGA configuration interface, (and optional High Level Synthesis tools) we can drastically reduce the time to deploy and test new FPGA designs. The target of choice is the Terasic DE10-Nano Cyclone V SoC board, mainly due to its immense popularity and amiable pricetag. This repo provides the necessary sources and tools to showcase rapid prototyping of new FPGA designs.

## Dependencies

Supported Host PC Operating Systems:

- Any Linux distro that can run Quartus (tested on Ubuntu 22.04)
- Windows 10

Install the following packages on the system:

- Quartus 22.1std for compilation (other std and lite versions might work too)

You will also need:

- The DE10-Nano board
- A prepared SD card with the Linux Console (kernel 4.5) v1.3 (2018-03-15) image from Terasic
- Micro USB and Ethernet cable for communication, power cable

## Files and Folders

- **build**
  Generated folder for the built artefacts e.g. bitstream files

- **doc**
  Documentation materials

- **src**
  Source code for building the design

- **sw**
  Software examples that can be run on the HPS

- **test**
  Testbench files and scripts for simulation tests of the Firmware via QuestaSim

- **util**
  Utilities and hardware scripts, e.g. for programming the device

- **build.sh**
  Bash script to build the design via Quartus

- **readme.md**
  This readme file

## Setup

You need to have the config file `.fpga_config_de10` present in your `~` home directory. It must contain the following (adjust to your machine):

```
QUARTUS_COMPILE_DIR_DE10="~/intelFPGA/22.1std/quartus/bin/"
SOC_IP_DE10="169.254.42.42"
```

Clone or download this repository.

## Build the Design

Run the `build.sh` script to build the design. It will generate QSYS and IP files, synthezise, place and route the complete design and build the desired artefacts.

You can clean up generated files with `git clean -fdx`.

## Building Buildroot

These instructions show how the build an SD card with the mainline Linux Kernel, U-Boot, and Buildroot root file system.

# Prerequisites

A Ubuntu 22.04 system was used for this build, but most Linux systems should work fine.

```
# For building U-Boot and the Linux kernel
sudo apt install libncurses-dev flex bison openssl \
        libssl-dev dkms libelf-dev libudev-dev libpci-dev \
        libiberty-dev autoconf bc libmpc-dev libgmp-dev
```

Create a directory to build everything in.

```
mkdir -p ~/de10
cd ~/de10
```
# Get an ARM toolchain

Download the latest stable armebv7-eabihf / glibc toolchain from bootlin.

```
# cd to de10 directory
mkdir toolchain
cd toolchain
wget https://toolchains.bootlin.com/downloads/releases/toolchains/armv7-eabihf/tarballs/armv7-eabihf--glibc--stable-2020.08-1.tar.bz2
tar -xf armv7-eabihf--glibc--stable-2020.08-1.tar.bz2
rm armv7-eabihf--glibc--stable-2020.08-1.tar.bz2
# The CROSS_COMPILE variable must be set in any terminal used to build u-boot or the kernel
export CROSS_COMPILE=$PWD/armv7-eabihf--glibc--stable-2020.08-1/bin/arm-linux-
```

# Build the u-boot bootloader

Some versions of U-boot don't seem to work properly on the DE10-Nano, so it is recommended to stick with the version stated below.

Make sure CROSS_COMPILE variable is still set in the environment.

```
# cd to de10 directory
git clone https://github.com/u-boot/u-boot.git
cd u-boot
# This is the latest version at time of writing
git checkout v2021.07
# Configure the the DE10 nano Intel FPGA SoC
make ARCH=arm socfpga_de10_nano_defconfig
# Optional: run make ARCH=arm menuconfig to have a play around
make ARCH=arm -j $(nproc)
# Desired output file is: u-boot/u-boot-with-spl.sfp
```

The defconfig for DE10-nano is in u-boot/configs/socfpga_de10_nano_defconfig. When this config is set, u-boot/arch/arm/mach-socfpga/Kconfig sets the device to: u-boot/board/terasic/de10-nano/. In u-boot/board/terasic/de10-nano/qts (qts = Quartus) there are 4 files that set ram timing, pin MUXing, and PLL settings. The defaults will work for most applications, but if required they can be changed manually, or can be generated from the BSP handover files generated by the Intel Quartus software. See u-boot/docs/README.socfpga for more info.


# Build the Linux kernel

Make sure CROSS_COMPILE variable is still set in the environment.

```
# cd to de10 directory
git clone https://github.com/torvalds/linux.git
cd linux
# This is the latest version at time of writing
git checkout v6.5
# Configure kernel
make ARCH=arm socfpga_defconfig
make ARCH=arm menuconfig
```

Set the following kernel options:

- Under General setup and uncheck "Automatically append version information to the version string" (optional).
- Under File systems, enable "Overlay Filesystem Support" and all the options under it.
- Under File systems, Pseudo File Systems, Enable "Userspace-driven configuration filesystem".

Build the kernel:

```
# Compile kernel - This will take several minutes
make ARCH=arm LOCALVERSION=zImage -j $(nproc)
# Desired output file is: linux/arch/arm/boot/zImage

# Optionally save the config for future use
make savedefconfig
mv defconfig arch/arm/configs/socfpga_de10_defconfig
```

## Access the FPGA logic via HPS

On Angstrom Linux you can utilize the `memtool` command to access the entire HPS address space, including the FPGA Slaves (AXI), the FPGA Lightweight (AXI Lite), the common SDRAM and more.
Refer to the [Cyclone V HPS Technical Reference Manual](https://www.intel.com/content/www/us/en/docs/programmable/683126/21-2/hard-processor-system-technical-reference.html). Refer to `src/soc.qsys` in Quartus for FPGA slave base addresses.

For a quick example on how to remotely access some FPGA status registers, run `util/ReadImageMetaInfo.sh`.
